import { isPlatformServer } from '@angular/common';
import { Hooks } from '../types';
import { addCssClassName, cssClassNames, hasCssClassName, removeCssClassName } from '../util/css.util';
import { isChildOfPicture, isImageElement, setImage, setImageAndSourcesToDefault, setImageAndSourcesToError, setImageAndSourcesToLazy, setSourcesToLazy } from '../util/util';
export class SharedHooks extends Hooks {
    setup(attributes) {
        setImageAndSourcesToDefault(attributes.element, attributes.defaultImagePath, attributes.useSrcset, attributes.cssBackgroundPrefix);
        addCssClassName(attributes.element, cssClassNames.loading);
        if (hasCssClassName(attributes.element, cssClassNames.loaded)) {
            removeCssClassName(attributes.element, cssClassNames.loaded);
        }
    }
    finally(attributes) {
        addCssClassName(attributes.element, cssClassNames.loaded);
        removeCssClassName(attributes.element, cssClassNames.loading);
    }
    loadImage(attributes) {
        if (this.skipLazyLoading(attributes)) {
            // Set the image right away for bots for better SEO
            return [attributes.imagePath];
        }
        const { element, useSrcset, imagePath, decode, cssBackgroundPrefix } = attributes;
        let img;
        if (isImageElement(element) && isChildOfPicture(element)) {
            const parentClone = element.parentNode.cloneNode(true);
            img = parentClone.getElementsByTagName('img')[0];
            setSourcesToLazy(img);
            setImage(img, imagePath, useSrcset, cssBackgroundPrefix);
        }
        else {
            img = new Image();
            if (isImageElement(element) && element.referrerPolicy) {
                img.referrerPolicy = element.referrerPolicy;
            }
            if (isImageElement(element) && element.sizes) {
                img.sizes = element.sizes;
            }
            if (useSrcset && 'srcset' in img) {
                img.srcset = imagePath;
            }
            else {
                img.src = imagePath;
            }
        }
        if (decode && img.decode) {
            return img.decode().then(() => imagePath);
        }
        return new Promise((resolve, reject) => {
            img.onload = () => resolve(imagePath);
            img.onerror = () => reject(null);
        });
    }
    setErrorImage(error, attributes) {
        const { element, useSrcset, errorImagePath, cssBackgroundPrefix } = attributes;
        setImageAndSourcesToError(element, errorImagePath, useSrcset, cssBackgroundPrefix);
        addCssClassName(element, cssClassNames.failed);
    }
    setLoadedImage(imagePath, attributes) {
        const { element, useSrcset, cssBackgroundPrefix } = attributes;
        setImageAndSourcesToLazy(element, imagePath, useSrcset, cssBackgroundPrefix);
    }
    isDisabled() {
        // Disable if SSR and the user isn't a bot
        return isPlatformServer(this.platformId) && !this.isBot();
    }
    skipLazyLoading(attributes) {
        return this.isBot(attributes);
    }
    isBot(attributes) {
        var _a;
        if ((_a = this.navigator) === null || _a === void 0 ? void 0 : _a.userAgent) {
            return /googlebot|bingbot|yandex|baiduspider|facebookexternalhit|twitterbot|rogerbot|linkedinbot|embedly|quora\ link\ preview|showyoubot|outbrain|pinterest\/0\.|pinterestbot|slackbot|vkShare|W3C_Validator|whatsapp|duckduckbot/i.test(this.navigator.userAgent);
        }
        return false;
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaG9va3MuanMiLCJzb3VyY2VSb290IjoiLi4vLi4vLi4vIiwic291cmNlcyI6WyJzcmMvc2hhcmVkLWhvb2tzL2hvb2tzLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBRSxnQkFBZ0IsRUFBRSxNQUFNLGlCQUFpQixDQUFDO0FBRW5ELE9BQU8sRUFBYyxLQUFLLEVBQUUsTUFBTSxVQUFVLENBQUM7QUFDN0MsT0FBTyxFQUFFLGVBQWUsRUFBRSxhQUFhLEVBQUUsZUFBZSxFQUFFLGtCQUFrQixFQUFFLE1BQU0sa0JBQWtCLENBQUM7QUFDdkcsT0FBTyxFQUFFLGdCQUFnQixFQUFFLGNBQWMsRUFBRSxRQUFRLEVBQUUsMkJBQTJCLEVBQUUseUJBQXlCLEVBQUUsd0JBQXdCLEVBQUUsZ0JBQWdCLEVBQUUsTUFBTSxjQUFjLENBQUM7QUFFOUssTUFBTSxPQUFnQixXQUFlLFNBQVEsS0FBUTtJQUNuRCxLQUFLLENBQUMsVUFBc0I7UUFDMUIsMkJBQTJCLENBQUMsVUFBVSxDQUFDLE9BQU8sRUFBRSxVQUFVLENBQUMsZ0JBQWdCLEVBQUUsVUFBVSxDQUFDLFNBQVMsRUFBRSxVQUFVLENBQUMsbUJBQW1CLENBQUMsQ0FBQztRQUNuSSxlQUFlLENBQUMsVUFBVSxDQUFDLE9BQU8sRUFBRSxhQUFhLENBQUMsT0FBTyxDQUFDLENBQUM7UUFFM0QsSUFBSSxlQUFlLENBQUMsVUFBVSxDQUFDLE9BQU8sRUFBRSxhQUFhLENBQUMsTUFBTSxDQUFDLEVBQUU7WUFDN0Qsa0JBQWtCLENBQUMsVUFBVSxDQUFDLE9BQU8sRUFBRSxhQUFhLENBQUMsTUFBTSxDQUFDLENBQUM7U0FDOUQ7SUFDSCxDQUFDO0lBRUQsT0FBTyxDQUFDLFVBQXNCO1FBQzVCLGVBQWUsQ0FBQyxVQUFVLENBQUMsT0FBTyxFQUFFLGFBQWEsQ0FBQyxNQUFNLENBQUMsQ0FBQztRQUMxRCxrQkFBa0IsQ0FBQyxVQUFVLENBQUMsT0FBTyxFQUFFLGFBQWEsQ0FBQyxPQUFPLENBQUMsQ0FB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Q0FBQyxVQUFzQjtRQUNwQyxPQUFPLElBQUksQ0FBQyxLQUFLLENBQUMsVUFBVSxDQUFDLENBQUM7SUFDaEMsQ0FBQztJQUVELEtBQUssQ0FBQyxVQUF1Qjs7UUFDM0IsVUFBSSxJQUFJLENBQUMsU0FBUywwQ0FBRSxTQUFTLEVBQUU7WUFDN0IsT0FBTyw0TkFBNE4sQ0FBQyxJQUFJLENBQ3RPLElBQUksQ0FBQyxTQUFTLENBQUMsU0FBUyxDQUN6QixDQUFDO1NBQ0g7UUFDRCxPQUFPLEtBQUssQ0FBQztJQUNmLENBQUM7Q0FDRiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IGlzUGxhdGZvcm1TZXJ2ZXIgfSBmcm9tICdAYW5ndWxhci9jb21tb24nO1xuaW1wb3J0IHsgT2JzZXJ2YWJsZUlucHV0IH0gZnJvbSAncnhqcyc7XG5pbXBvcnQgeyBBdHRyaWJ1dGVzLCBIb29rcyB9IGZyb20gJy4uL3R5cGVzJztcbmltcG9ydCB7IGFkZENzc0NsYXNzTmFtZSwgY3NzQ2xhc3NOYW1lcywgaGFzQ3NzQ2xhc3NOYW1lLCByZW1vdmVDc3NDbGFzc05hbWUgfSBmcm9tICcuLi91dGlsL2Nzcy51dGlsJztcbmltcG9ydCB7IGlzQ2hpbGRPZlBpY3R1cmUsIGlzSW1hZ2VFbGVtZW50LCBzZXRJbWFnZSwgc2V0SW1hZ2VBbmRTb3VyY2VzVG9EZWZhdWx0LCBzZXRJbWFnZUFuZFNvdXJjZXNUb0Vycm9yLCBzZXRJbWFnZUFuZFNvdXJjZXNUb0xhenksIHNldFNvdXJjZXNUb0xhenkgfSBmcm9tICcuLi91dGlsL3V0aWwnO1xuXG5leHBvcnQgYWJzdHJhY3QgY2xhc3MgU2hhcmVkSG9va3M8RT4gZXh0ZW5kcyBIb29rczxFPiB7XG4gIHNldHVwKGF0dHJpYnV0ZXM6IEF0dHJpYnV0ZXMpOiB2b2lkIHtcbiAgICBzZXRJbWFnZUFuZFNvdXJjZXNUb0RlZmF1bHQoYXR0cmlidXRlcy5lbGVtZW50LCBhdHRyaWJ1dGVzLmRlZmF1bHRJbWFnZVBhdGgsIGF0dHJpYnV0ZXMudXNlU3Jjc2V0LCBhdHRyaWJ1dGVzLmNzc0JhY2tncm91bmRQcmVmaXgpO1xuICAgIGFkZENzc0NsYXNzTmFtZShhdHRyaWJ1dGVzLmVsZW1lbnQsIGNzc0NsYXNzTmFtZXMubG9hZGluZyk7XG5cbiAgICBpZiAoaGFzQ3NzQ2xhc3NOYW1lKGF0dHJpYnV0ZXMuZWxlbWVudCwgY3NzQ2xhc3NOYW1lcy5sb2FkZWQpKSB7XG4gICAgICByZW1vdmVDc3NDbGFzc05hbWUoYXR0cmlidXRlcy5lbGVtZW50LCBjc3NDbGFzc05hbWVzLmxvYWRlZCk7XG4gICAgfVxuICB9XG5cbiAgZmluYWxseShhdHRyaWJ1dGVzOiBBdHRyaWJ1dGVzKTogdm9pZCB7XG4gICAgYWRkQ3NzQ2xhc3NOYW1lKGF0dHJpYnV0ZXMuZWxlbWVudCwgY3NzQ2xhc3NOYW1lcy5sb2FkZWQpO1xuICAgIHJlbW92ZUNzc0NsYXNzTmFtZShhdHRyaWJ1dGVzLmVsZW1lbnQsIGNzc0NsYXNzTmFtZXMubG9hZGluZyk7XG4gIH1cblxuICBsb2FkSW1hZ2UoYXR0cmlidXRlczogQXR0cmlidXRlcyk6IE9ic2VydmFibGVJbnB1dDxzdHJpbmc+IHtcbiAgICBpZiAodGhpcy5za2lwTGF6eUxvYWRpbmcoYXR0cmlidXRlcykpIHtcbiAgICAgIC8vIFNldCB0aGUgaW1hZ2UgcmlnaHQgYXdheSBmb3IgYm90cyBmb3IgYmV0dGVyIFNFT1xuICAgICAgcmV0dXJuIFthdHRyaWJ1dGVzLmltYWdlUGF0aF07XG4gICAgfVxuICAgIGNvbnN0IHsgZWxlbWVudCwgdXNlU3Jjc2V0LCBpbWFnZVBhdGgsIGRlY29kZSwgY3NzQmFja2dyb3VuZFByZWZpeCB9ID0gYXR0cmlidXRlcztcbiAgICBsZXQgaW1nOiBIVE1MSW1hZ2VFbGVtZW50O1xuICAgIGlmIChpc0ltYWdlRWxlbWVudChlbGVtZW50KSAmJiBpc0NoaWxkT2ZQaWN0dXJlKGVsZW1lbnQpKSB7XG4gICAgICBjb25zdCBwYXJlbnRDbG9uZSA9IGVsZW1lbnQucGFyZW50Tm9kZSEuY2xvbmVOb2RlKHRydWUpIGFzIEhUTUxQaWN0dXJlRWxlbWVudDtcbiAgICAgIGltZyA9IHBhcmVudENsb25lLmdldEVsZW1lbnRzQnlUYWdOYW1lKCdpbWcnKVswXTtcbiAgICAgIHNldFNvdXJjZXNUb0xhenkoaW1nKTtcbiAgICAgIHNldEltYWdlKGltZywgaW1hZ2VQYXRoLCB1c2VTcmNzZXQsIGNzc0JhY2tncm91bmRQcmVmaXgpO1xuICAgIH0gZWxzZSB7XG4gICAgICBpbWcgPSBuZXcgSW1hZ2UoKTtcbiAgICAgIGlmIChpc0ltYWdlRWxlbWVudChlbGVtZW50KSAmJiBlbGVtZW50LnJlZmVycmVyUG9saWN5KSB7XG4gICAgICAgIGltZy5yZWZlcnJlclBvbGljeSA9IGVsZW1lbnQucmVmZXJyZXJQb2xpY3k7XG4gICAgICB9XG4gICAgICBpZiAoaXNJbWFnZUVsZW1lbnQoZWxlbWVudCkgJiYgZWxlbWVudC5zaXplcykge1xuICAgICAgICBpbWcuc2l6ZXMgPSBlbGVtZW50LnNpemVzO1xuICAgICAgfVxuICAgICAgaWYgKHVzZVNyY3NldCAmJiAnc3Jjc2V0JyBpbiBpbWcpIHtcbiAgICAgICAgaW1nLnNyY3NldCA9IGltYWdlUGF0aDtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGltZy5zcmMgPSBpbWFnZVBhdGg7XG4gICAgICB9XG4gICAgfVxuXG4gICAgaWYgKGRlY29kZSAmJiBpbWcuZGVjb2RlKSB7XG4gICAgICByZXR1cm4gaW1nLmRlY29kZSgpLnRoZW4oKCkgPT4gaW1hZ2VQYXRoKTtcbiAgICB9XG5cbiAgICByZXR1cm4gbmV3IFByb21pc2U8c3RyaW5nPigocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG4gICAgICBpbWcub25sb2FkID0gKCkgPT4gcmVzb2x2ZShpbWFnZVBhdGgpO1xuICAgICAgaW1nLm9uZXJyb3IgPSAoKSA9PiByZWplY3QobnVsbCk7XG4gICAgfSk7XG4gIH1cblxuICBzZXRFcnJvckltYWdlKGVycm9yOiBFcnJvciwgYXR0cmlidXRlczogQXR0cmlidXRlcyk6IHZvaWQge1xuICAgIGNvbnN0IHsgZWxlbWVudCwgdXNlU3Jjc2V0LCBlcnJvckltYWdlUGF0aCwgY3NzQmFja2dyb3VuZFByZWZpeCB9ID0gYXR0cmlidXRlcztcbiAgICBzZXRJbWFnZUFuZFNvdXJjZXNUb0Vycm9yKGVsZW1lbnQsIGVycm9ySW1hZ2VQYXRoLCB1c2VTcmNzZXQsIGNzc0JhY2tncm91bmRQcmVmaXgpO1xuICAgIGFkZENzc0NsYXNzTmFtZShlbGVtZW50LCBjc3NDbGFzc05hbWVzLmZhaWxlZCk7XG4gIH1cblxuICBzZXRMb2FkZWRJbWFnZShpbWFnZVBhdGg6IHN0cmluZywgYXR0cmlidXRlczogQXR0cmlidXRlcyk6IHZvaWQge1xuICAgIGNvbnN0IHsgZWxlbWVudCwgdXNlU3Jjc2V0LCBjc3NCYWNrZ3JvdW5kUHJlZml4IH0gPSBhdHRyaWJ1dGVzO1xuICAgIHNldEltYWdlQW5kU291cmNlc1RvTGF6eShlbGVtZW50LCBpbWFnZVBhdGgsIHVzZVNyY3NldCwgY3NzQmFja2dyb3VuZFByZWZpeCk7XG4gIH1cblxuICBpc0Rpc2FibGVkKCk6IGJvb2xlYW4ge1xuICAgIC8vIERpc2FibGUgaWYgU1NSIGFuZCB0aGUgdXNlciBpc24ndCBhIGJvdFxuICAgIHJldHVybiBpc1BsYXRmb3JtU2VydmVyKHRoaXMucGxhdGZvcm1JZCkgJiYgIXRoaXMuaXNCb3QoKTtcbiAgfVxuXG4gIHNraXBMYXp5TG9hZGluZyhhdHRyaWJ1dGVzOiBBdHRyaWJ1dGVzKTogYm9vbGVhbiB7XG4gICAgcmV0dXJuIHRoaXMuaXNCb3QoYXR0cmlidXRlcyk7XG4gIH1cblxuICBpc0JvdChhdHRyaWJ1dGVzPzogQXR0cmlidXRlcyk6IGJvb2xlYW4ge1xuICAgIGlmICh0aGlzLm5hdmlnYXRvcj8udXNlckFnZW50KSB7XG4gICAgICByZXR1cm4gL2dvb2dsZWJvdHxiaW5nYm90fHlhbmRleHxiYWlkdXNwaWRlcnxmYWNlYm9va2V4dGVybmFsaGl0fHR3aXR0ZXJib3R8cm9nZXJib3R8bGlua2VkaW5ib3R8ZW1iZWRseXxxdW9yYVxcIGxpbmtcXCBwcmV2aWV3fHNob3d5b3Vib3R8b3V0YnJhaW58cGludGVyZXN0XFwvMFxcLnxwaW50ZXJlc3Rib3R8c2xhY2tib3R8dmtTaGFyZXxXM0NfVmFsaWRhdG9yfHdoYXRzYXBwfGR1Y2tkdWNrYm90L2kudGVzdChcbiAgICAgICAgdGhpcy5uYXZpZ2F0b3IudXNlckFnZW50XG4gICAgICApO1xuICAgIH1cbiAgICByZXR1cm4gZmFsc2U7XG4gIH1cbn1cbiJdfQ==